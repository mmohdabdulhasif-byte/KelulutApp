<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>An-Naas Kelulut Bekeng</title>
  <meta name="theme-color" content="#FFD700">

  <!-- Stylesheets -->
  <link rel="manifest" href="./manifest.json">
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="./assets/css/redesign_dark.css">

  <!-- Chart.js for Charts page -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Identity Services -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- Service Worker Check untuk GitHub Pages -->
  <script>
    // Check if service worker is supported and register
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(registration => {
          console.log('SW registered: ', registration);
        })
        .catch(registrationError => {
          console.log('SW registration failed: ', registrationError);
        });
    }

    // Fallback untuk GitHub Pages
    window.isGitHubPages = window.location.hostname.includes('github.io');
  </script>

  <style>
    /* SPA Navigation Styles */
    .page {
      display: none;
    }
    .page.active {
      display: block;
    }
    
    /* Original Styles */
    body { font-family: 'Segoe UI', sans-serif; margin:0; background:#0b0c10; color:#e6e7e9; }
    .header { background:#FFD700; color:#000; padding:10px 20px; display:flex; align-items:center; gap:12px; }
    .brand img { height:48px; }
    .brand .main { font-weight:700; font-size:1.2rem; }
    .brand .sub { font-size:0.9rem; opacity:0.8; }
    .container { padding:20px; }
    .controls button { margin:4px; }
    .card-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; margin-top:20px; }
    .card { background:#1b1e24; padding:20px; border-radius:10px; text-align:center; }
    #gdrive-ui { position:fixed; right:12px; bottom:12px; z-index:9999; display:flex; gap:8px; flex-wrap:wrap; }
    button.gbtn { padding:10px 14px; border:none; border-radius:8px; font-weight:600; cursor:pointer; transition: all 0.2s ease; }
    button.gbtn:hover { opacity: 0.9; transform: translateY(-1px); }
    button.connect { background:#1a73e8; color:white; }
    button.backup { background:#34a853; color:white; }
    button.restore { background:#fbbc05; color:#000; }
    button.logout { background:#ea4335; color:white; }
    .status-connected { color:#34a853; }
    .status-disconnected { color:#ea4335; }

    /* Settings Page Styles */
    .settings-container { max-width: 600px; margin: 0 auto; }
    .settings-container label { display: block; margin-top: 15px; }
    .settings-container input { width: 100%; padding: 8px; margin-top: 5px; }
    .settings-container button { margin-top: 10px; padding: 10px 15px; }

    /* Offline Page Styles */
    .offline-container { text-align: center; margin-top: 60px; }

    /* Form Styles */
    .form-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .input { padding: 8px 12px; border: 1px solid #444; border-radius: 6px; background: #1a1d23; color: white; }
    .note { margin-top: 20px; padding: 10px; background: #1a1d23; border-radius: 6px; }

    /* Table Styles */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #444; }
    th { background: #2a2d33; }

    /* üîî Notification UI */
    #notifyBox {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-family: "Segoe UI", sans-serif;
    }
    .notify {
      padding: 12px 16px;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      min-width: 220px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }
    .notify.show { opacity: 1; transform: translateY(0); }
    .notify.success { background: #34a853; }
    .notify.error { background: #ea4335; }
    .notify.info { background: #1a73e8; }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <div class="brand">
      <img src="./assets/logo.png" alt="logo">
      <div class="title">
        <div class="main">An-Naas Kelulut Bekeng</div>
        <div class="sub">Premium Kelulut Honey Management</div>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="container">
    <div class="controls">
      <button class="nav-btn" data-page="dashboard">Dashboard</button>
      <button class="nav-btn" data-page="colonies">Koloni</button>
      <button class="nav-btn" data-page="harvests">Hasil</button>
      <button class="nav-btn" data-page="care">Penjagaan</button>
      <button class="nav-btn" data-page="reports">Laporan</button>
      <button class="nav-btn" data-page="sales">Jualan</button>
      <button class="nav-btn" data-page="inventory">Stok</button>
      <button class="nav-btn" data-page="invoices">Invois</button>
      <button class="nav-btn" data-page="charts">Graf</button>
      <button class="nav-btn" data-page="settings">Settings</button>
      <span id="driveStatus" style="margin-left:12px">Drive: Disconnected ‚ùå</span>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboard" class="page active">
      <h2>Dashboard</h2>
      <div class="card-grid">
        <div class="card"><strong id="countColonies">0</strong><div>Jumlah Koloni</div></div>
        <div class="card"><strong id="totalHarvest">0</strong><div>Jumlah Hasil (kg)</div></div>
        <div class="card"><strong id="monthlySales">0</strong><div>Jualan Bulanan (RM)</div></div>
        <div class="card"><strong id="dueCare">0</strong><div>Penjagaan Hari Ini</div></div>
      </div>
    </div>

    <!-- Colonies Page -->
    <div id="colonies" class="page">
      <h2>Koloni</h2>
      <form id="formColony" class="form-row">
        <input id="colonyName" class="input" placeholder="Nama Koloni" required>
        <select id="colonyStatus" class="input">
          <option value="active">Aktif</option>
          <option value="rest">Rehat</option>
          <option value="problem">Bermasalah</option>
        </select>
        <input id="colonyStart" type="date" class="input">
        <button type="submit">Tambah Koloni</button>
      </form>
      <table id="colonyTable">
        <thead>
          <tr><th>Nama</th><th>Status</th><th>Mula</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="note">
        <button onclick="exportStoreXLSX('colonies')">Export Excel</button>
        <button onclick="exportReportPDF('colonyTable')">Export PDF</button>
      </div>
    </div>

    <!-- Harvests Page -->
    <div id="harvests" class="page">
      <h2>Hasil Tuai</h2>
      <form id="formHarvest" class="form-row">
        <select id="harvestColony" class="input"></select>
        <input id="harvestKg" class="input" type="number" step="0.1" placeholder="Berat (kg)">
        <input id="harvestDate" class="input" type="date">
        <button type="submit">Rekod Hasil</button>
      </form>
      <table id="harvestTable">
        <thead>
          <tr><th>Koloni</th><th>Kg</th><th>Tarikh</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="note">
        <button onclick="exportStoreXLSX('harvests')">Export Excel</button>
        <button onclick="exportReportPDF('harvestTable')">Export PDF</button>
      </div>
    </div>

    <!-- Care Page -->
    <div id="care" class="page">
      <h2>Penjagaan</h2>
      <form id="formCare" class="form-row">
        <select id="careColony" class="input"></select>
        <input id="careTitle" class="input" placeholder="Apa yang perlu dibuat">
        <input id="careRemind" class="input" type="datetime-local">
        <button type="submit">Tambah Log Penjagaan</button>
      </form>
      <table id="careTable">
        <thead>
          <tr>
            <th>Koloni</th>
            <th>Tugas</th>
            <th>Remind At</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="note">
        <button onclick="exportStoreXLSX('careLogs')">Export Excel</button>
        <button onclick="exportReportPDF('careTable')">Export PDF</button>
      </div>
    </div>

    <!-- Reports Page -->
    <div id="reports" class="page">
      <h2>Laporan</h2>
      <div id="reportContainer" class="report-card">
        <h3>Ringkasan Operasi</h3>
        <p>Jumlah Koloni: <strong id="rCountColonies">0</strong></p>
        <p>Jumlah Hasil (kg): <strong id="rTotalHarvest">0</strong></p>
        <p>Jualan Bulanan (RM): <strong id="rMonthlySales">0</strong></p>
      </div>
      <div class="note">
        <button onclick="exportStoreXLSX('colonies')">Export Koloni Excel</button>
        <button onclick="exportStoreXLSX('harvests')">Export Hasil Excel</button>
        <button onclick="exportReportPDF('reportContainer')">Generate PDF</button>
      </div>
    </div>

    <!-- Sales Page -->
    <div id="sales" class="page">
      <h2>Rekod Jualan</h2>
      <form id="formSale" class="form-row">
        <input id="saleCustomer" class="input" placeholder="Nama Pelanggan">
        <input id="saleQty" class="input" type="number" placeholder="Kuantiti">
        <input id="saleAmount" class="input" type="number" placeholder="Jumlah (RM)">
        <input id="saleDate" class="input" type="date">
        <button type="submit">Tambah Jualan</button>
      </form>
      <table id="salesTable">
        <thead>
          <tr><th>Pelanggan</th><th>Kuantiti</th><th>Jumlah</th><th>Tarikh</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="note">
        <button onclick="exportStoreXLSX('sales')">Export Excel</button>
        <button onclick="exportReportPDF('salesTable')">Export PDF</button>
      </div>
    </div>

    <!-- Inventory Page -->
    <div id="inventory" class="page">
      <h2>Inventori Stok</h2>
      <form id="formInv" class="form-row">
        <input id="invItem" class="input" placeholder="Nama Barang">
        <input id="invQty" class="input" type="number" placeholder="Kuantiti">
        <button type="submit">Tambah Stok</button>
      </form>
      <table id="invTable">
        <thead>
          <tr><th>Item</th><th>Kuantiti</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="note">
        <button onclick="exportStoreXLSX('inventory')">Export Excel</button>
        <button onclick="exportReportPDF('invTable')">Export PDF</button>
      </div>
    </div>

    <!-- Invoices Page -->
    <div id="invoices" class="page">
      <h2>Rekod Invois</h2>
      <form id="formInvc" class="form-row">
        <input id="invcCustomer" class="input" placeholder="Nama Pelanggan">
        <input id="invcTotal" class="input" type="number" placeholder="Jumlah (RM)">
        <input id="invcDate" class="input" type="date">
        <button type="submit">Tambah Invois</button>
      </form>
      <table id="invcTable">
        <thead>
          <tr><th>Pelanggan</th><th>Jumlah</th><th>Tarikh</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="note">
        <button onclick="exportStoreXLSX('invoices')">Export Excel</button>
        <button onclick="exportReportPDF('invcTable')">Export PDF</button>
      </div>
    </div>

    <!-- Charts Page -->
    <div id="charts" class="page">
      <h2>Carta Prestasi Hasil Tuai</h2>
      <canvas id="chartCanvas" style="width:100%;max-width:800px;height:400px;background:var(--card);border-radius:12px;padding:10px;"></canvas>
      <div class="note">
        <button onclick="renderChart()">Refresh Chart</button>
        <button onclick="exportStoreXLSX('harvests')">Export Harvests Excel</button>
      </div>
    </div>

    <!-- Settings Page -->
    <div id="settings" class="page">
      <div class="settings-container">
        <h2>Settings & Backup</h2>
        <p>Nota: Google Drive sync hanya berfungsi bila dibuka dalam Safari (tab), bukan PWA standalone di iOS.</p>
        <label>Google OAuth Web Client ID:</label>
        <input id="gClientId" placeholder="client-id.apps.googleusercontent.com">
        
        <label>Backup filename prefix:</label>
        <input id="backupPrefix" value="kelulut_backup_">
        
        <button id="btnSignIn">Sign in to Google Drive (Safari only)</button>
        <button id="btnBackup">Backup to Drive</button>
        <button id="btnRestore">Restore from Drive</button>
        <button id="btnExportZip">Export ZIP to Files</button>
        
        <pre id="status" style="background:#f4f4f4;padding:8px;margin-top:8px"></pre>
        
        <label>Upload Logo (PNG):</label>
        <input id="kelulutLogoUpload" type="file" accept="image/png,.png">
        <button id="btnRemoveLogo" style="display:block;margin-top:8px">Remove Logo</button>
      </div>
    </div>

    <!-- Offline Page -->
    <div id="offline" class="page">
      <div class="offline-container">
        <h2>Mod Luar Talian</h2>
        <p>Anda sedang offline. Beberapa ciri mungkin tidak tersedia.</p>
        <p>Sila sambung semula ke internet atau gunakan data yang disimpan.</p>
        <button onclick="window.location.reload()" style="margin-top:20px;padding:10px 18px;border:none;border-radius:8px;background:#FFD700;color:#000;font-weight:600;">Cuba Semula</button>
      </div>
    </div>

    <footer style="margin-top:20px;text-align:center;opacity:0.7;">Kelulut Management System</footer>
  </div>

  <!-- Drive UI -->
  <div id="gdrive-ui">
    <button class="gbtn connect" onclick="manualConnect()">Connect Google Drive</button>
    <button class="gbtn backup" onclick="manualBackup()">Backup Now</button>
    <button class="gbtn restore" onclick="manualRestore()">Restore</button>
    <button class="gbtn logout" onclick="manualSignOut()">Logout</button>
  </div>

  <!-- üîî Notification Box -->
  <div id="notifyBox"></div>

  <!-- Debug Panel untuk GitHub Pages -->
  <div id="debugPanel" style="position:fixed; bottom:10px; left:10px; background:rgba(0,0,0,0.8); color:white; padding:10px; border-radius:5px; font-size:12px; display:none; z-index:10000;">
    <div id="debugInfo">Debug info will appear here</div>
    <button onclick="toggleDebug()" style="margin:2px; padding:4px;">Toggle Debug</button>
    <button onclick="clearLocalData()" style="margin:2px; padding:4px;">Clear Data</button>
    <button onclick="testAddColony()" style="margin:2px; padding:4px;">Test Add Colony</button>
  </div>

<!-- SEMUA JAVASCRIPT DALAM SATU FILE -->
  <script>
    // =============================================
    // db.js - Database Functions
    // =============================================
    (function(window){
      const DB_NAME = "KelulutDB";
      const DB_VERSION = 1;
      const STORES = ["colonies","harvests","sales","invoices","inventory","careLogs"];

      const openDB = () => {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onerror = () => {
            console.error('IndexedDB error:', req.error);
            reject(req.error);
          };
          req.onsuccess = () => {
            console.log('IndexedDB initialized successfully');
            resolve(req.result);
          };
          req.onupgradeneeded = (e) => {
            const db = e.target.result;
            console.log('Upgrading database...');
            for (const s of STORES) {
              if (!db.objectStoreNames.contains(s)) {
                db.createObjectStore(s, { keyPath: "id" });
                console.log('Created object store:', s);
              }
            }
          };
        });
      };

      const promisifyRequest = (req) => {
        return new Promise((resolve, reject) => {
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      };

      const genId = () => {
        return `${Date.now()}-${Math.random().toString(36).slice(2,9)}`;
      };

      const runTx = async (storeName, mode, cb) => {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, mode);
          const store = tx.objectStore(storeName);
          let result;
          try {
            result = cb(store);
          } catch (err) {
            reject(err);
          }
          tx.oncomplete = () => resolve(result);
          tx.onerror = () => reject(tx.error);
        });
      };

      const api = {
        init: async function(){
          console.log('Initializing database...');
          try {
            const db = await openDB();
            console.log('Database ready');
            return true;
          } catch (error) {
            console.error('Database initialization failed:', error);
            throw error;
          }
        },

        add: async function(storeName, item){
          if (!STORES.includes(storeName)) throw new Error("Invalid store: "+storeName);
          if (!item.id) item.id = genId();
          const now = new Date().toISOString();
          item.createdAt = item.createdAt || now;
          item.updatedAt = now;
          await runTx(storeName, "readwrite", (store) => {
            store.add(item);
          });
          return item.id;
        },

        put: async function(storeName, item){
          if (!STORES.includes(storeName)) throw new Error("Invalid store: "+storeName);
          if (!item.id) item.id = genId();
          item.updatedAt = new Date().toISOString();
          await runTx(storeName, "readwrite", (store) => {
            store.put(item);
          });
          return item.id;
        },

        get: async function(storeName, id){
          if (!STORES.includes(storeName)) throw new Error("Invalid store: "+storeName);
          return runTx(storeName, "readonly", (store) => {
            const req = store.get(id);
            return promisifyRequest(req);
          });
        },

        getAll: async function(storeName){
          if (!STORES.includes(storeName)) throw new Error("Invalid store: "+storeName);
          return runTx(storeName, "readonly", (store) => {
            const req = store.getAll();
            return promisifyRequest(req);
          });
        },

        delete: async function(storeName, id){
          if (!STORES.includes(storeName)) throw new Error("Invalid store: "+storeName);
          await runTx(storeName, "readwrite", (store) => {
            store.delete(id);
          });
          return true;
        },

        clear: async function(storeName){
          if (!STORES.includes(storeName)) throw new Error("Invalid store: "+storeName);
          await runTx(storeName, "readwrite", (store) => {
            store.clear();
          });
          return true;
        },

        exportAll: async function(){
          const out = {};
          for (const s of STORES){
            out[s] = await this.getAll(s);
          }
          return out;
        },

        importAll: async function(obj){
          for (const s of STORES){
            if (Array.isArray(obj[s])){
              for (const item of obj[s]){
                if (!item.id) item.id = genId();
                await this.put(s, item);
              }
            }
          }
          return true;
        }
      };

      // Expose functions globally for backward compatibility
      window.db = api;
      window.getAll = (storeName) => db.getAll(storeName);
      window.addRecord = (storeName, item) => db.add(storeName, item);
      window.deleteRecord = (storeName, id) => db.delete(storeName, id);

    })(window);

    // =============================================
    // main.js - Main Application Logic
    // =============================================
    (function(window){
      const CLIENT_ID = "253249814475-79vie8d9ovh5evmh6ra69q01ot8g5rd6.apps.googleusercontent.com";
      const SCOPES = "https://www.googleapis.com/auth/drive.file";

      let accessToken = null;
      let tokenClient = null;
      let autoBackupTimer = null;

      // Initialize Google Identity Services
      async function initGIS(){
        return new Promise((resolve,reject)=>{
          try {
            tokenClient = google.accounts.oauth2.initTokenClient({
              client_id: CLIENT_ID,
              scope: SCOPES,
              callback: (resp) => {
                if (resp && resp.access_token) {
                  accessToken = resp.access_token;
                  notify("‚úÖ Disambung ke Google Drive", "success");
                  updateDriveStatus(true);
                  resolve(accessToken);
                } else {
                  reject(new Error("No token"));
                }
              }
            });
            resolve(true);
          } catch (err){
            reject(err);
          }
        });
      }

      // Manual Connect to Google Drive
      async function manualConnect(){
        try {
          if (!tokenClient) await initGIS();
          tokenClient.requestAccessToken();
        } catch (err){
          console.error(err);
          notify("‚ùå GIS init error: " + err.message, "error");
        }
      }

      // Manual Sign Out
      function manualSignOut(){
        accessToken = null;
        updateDriveStatus(false);
        notify("üëã Log keluar dari Google Drive", "info");
      }

      // Update Drive Status
      function updateDriveStatus(connected){
        const el = document.getElementById("driveStatus");
        if (!el) return;
        el.textContent = connected ? "Drive: Connected ‚úÖ" : "Drive: Disconnected ‚ùå";
        el.className = connected ? "status-connected" : "status-disconnected";
      }

      // Notification Helper
      function notify(msg, type="info"){
        const box = document.getElementById("notifyBox");
        if (!box) return;
        const div = document.createElement("div");
        div.className = `notify ${type}`;
        div.textContent = msg;
        box.appendChild(div);
        setTimeout(()=> div.classList.add("show"), 50);
        setTimeout(()=> {
          div.classList.remove("show");
          setTimeout(()=> div.remove(), 300);
        }, 3500);
      }

      // Initialize all forms and tables for SPA
      async function initializePage(pageId) {
        console.log('Initializing page:', pageId);
        switch(pageId) {
          case 'dashboard':
            await updateDashboard();
            break;
          case 'colonies':
            await initializeColonies();
            break;
          case 'harvests':
            await initializeHarvests();
            break;
          case 'care':
            await initializeCare();
            break;
          case 'sales':
            await initializeSales();
            break;
          case 'inventory':
            await initializeInventory();
            break;
          case 'invoices':
            await initializeInvoices();
            break;
          case 'reports':
            await updateReports();
            break;
          case 'charts':
            renderChart();
            break;
          case 'settings':
            initializeSettings();
            break;
        }
      }

      // Dashboard functions
      async function updateDashboard() {
        try {
          const colonies = await db.getAll('colonies');
          const harvests = await db.getAll('harvests');
          const sales = await db.getAll('sales');
          const careLogs = await db.getAll('careLogs');
          
          const totalHarvest = harvests.reduce((sum, h) => sum + (parseFloat(h.kg) || 0), 0);
          const monthlySales = sales
            .filter(s => {
              const saleDate = new Date(s.date);
              const now = new Date();
              return saleDate.getMonth() === now.getMonth() && saleDate.getFullYear() === now.getFullYear();
            })
            .reduce((sum, s) => sum + (parseFloat(s.amount) || 0), 0);
          
          const today = new Date().toDateString();
          const dueCare = careLogs.filter(c => {
            const careDate = new Date(c.remindAt);
            return careDate.toDateString() === today;
          }).length;

          document.getElementById('countColonies').textContent = colonies.length;
          document.getElementById('totalHarvest').textContent = totalHarvest.toFixed(1);
          document.getElementById('monthlySales').textContent = monthlySales.toFixed(2);
          document.getElementById('dueCare').textContent = dueCare;
        } catch (error) {
          console.error('Error updating dashboard:', error);
        }
      }

      // Colonies Management
      async function initializeColonies() {
        console.log('Initializing colonies page...');
        
        const form = document.getElementById('formColony');
        if (form) {
          console.log('Colony form found, adding event listener...');
          
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Form submitted!');
            
            const name = document.getElementById('colonyName').value;
            const status = document.getElementById('colonyStatus').value;
            const start = document.getElementById('colonyStart').value;
            
            console.log('Form data:', { name, status, start });
            
            if (!name) {
              notify('Sila masukkan nama koloni', 'error');
              return;
            }
            
            try {
              console.log('Attempting to add colony to database...');
              const result = await db.add('colonies', { 
                name, 
                status, 
                start,
                createdAt: new Date().toISOString()
              });
              
              console.log('Colony added successfully, ID:', result);
              notify('Koloni berjaya ditambah', 'success');
              form.reset();
              await renderColoniesTable();
              await updateDashboard(); // Update dashboard counts
              updateDebugInfo(); // Update debug panel
            } catch (error) {
              console.error('Error adding colony:', error);
              notify('Gagal menambah koloni: ' + error.message, 'error');
            }
          });
        } else {
          console.error('Colony form not found!');
        }
        
        await renderColoniesTable();
      }

      async function renderColoniesTable() {
        const tbody = document.querySelector('#colonyTable tbody');
        if (!tbody) {
          console.error('Colony table tbody not found!');
          return;
        }
        
        try {
          const colonies = await db.getAll('colonies');
          console.log('Rendering colonies table, count:', colonies.length);
          tbody.innerHTML = '';
          
          if (colonies.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Tiada koloni. Sila tambah koloni baru.</td></tr>';
            return;
          }
          
          colonies.forEach(colony => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${escapeHtml(colony.name)}</td>
              <td>${escapeHtml(colony.status)}</td>
              <td>${escapeHtml(colony.start || '')}</td>
              <td>
                <button onclick="deleteColony('${colony.id}')">Padam</button>
              </td>
            `;
            tbody.appendChild(row);
          });
        } catch (error) {
          console.error('Error rendering colonies:', error);
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:red;">Error loading colonies</td></tr>';
        }
      }

      // Similar functions for other pages (implementasi asas)
      async function initializeHarvests() {
        await renderHarvestsTable();
        await populateColonyDropdown('harvestColony');
      }

      async function initializeCare() {
        await renderCareTable();
        await populateColonyDropdown('careColony');
      }

      async function initializeSales() {
        await renderSalesTable();
      }

      async function initializeInventory() {
        await renderInventoryTable();
      }

      async function initializeInvoices() {
        await renderInvoicesTable();
      }

      async function updateReports() {
        try {
          const colonies = await db.getAll('colonies');
          const harvests = await db.getAll('harvests');
          const sales = await db.getAll('sales');
          
          const totalHarvest = harvests.reduce((sum, h) => sum + (parseFloat(h.kg) || 0), 0);
          const monthlySales = sales
            .filter(s => {
              const saleDate = new Date(s.date);
              const now = new Date();
              return saleDate.getMonth() === now.getMonth() && saleDate.getFullYear() === now.getFullYear();
            })
            .reduce((sum, s) => sum + (parseFloat(s.amount) || 0), 0);

          document.getElementById('rCountColonies').textContent = colonies.length;
          document.getElementById('rTotalHarvest').textContent = totalHarvest.toFixed(1);
          document.getElementById('rMonthlySales').textContent = monthlySales.toFixed(2);
        } catch (error) {
          console.error('Error updating reports:', error);
        }
      }

      // Helper functions
      async function populateColonyDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        
        try {
          const colonies = await db.getAll('colonies');
          dropdown.innerHTML = '<option value="">Pilih Koloni</option>';
          colonies.forEach(colony => {
            const option = document.createElement('option');
            option.value = colony.id;
            option.textContent = colony.name;
            dropdown.appendChild(option);
          });
        } catch (error) {
          console.error('Error populating colony dropdown:', error);
        }
      }

      function escapeHtml(str){
        if (typeof str !== "string") return str;
        return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      }

      // Basic table renderers (placeholder implementations)
      async function renderHarvestsTable() {
        const tbody = document.querySelector('#harvestTable tbody');
        if (!tbody) return;
        
        try {
          const harvests = await db.getAll('harvests');
          tbody.innerHTML = '';
          
          harvests.forEach(harvest => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${escapeHtml(harvest.colonyId || '')}</td>
              <td>${escapeHtml(harvest.kg || '')}</td>
              <td>${escapeHtml(harvest.date || '')}</td>
              <td><button onclick="deleteRecord('harvests','${harvest.id}')">Padam</button></td>
            `;
            tbody.appendChild(row);
          });
        } catch (error) {
          console.error('Error rendering harvests:', error);
        }
      }

      async function renderCareTable() {
        // Similar implementation for care table
      }

      async function renderSalesTable() {
        // Similar implementation for sales table
      }

      async function renderInventoryTable() {
        // Similar implementation for inventory table
      }

      async function renderInvoicesTable() {
        // Similar implementation for invoices table
      }

      // Export functions to global scope
      window.manualConnect = manualConnect;
      window.manualSignOut = manualSignOut;
      window.manualBackup = manualBackup;
      window.manualRestore = manualRestore;
      window.updateDashboard = updateDashboard;
      window.initializePage = initializePage;
      window.deleteColony = async (id) => {
        if (confirm('Padam koloni ini?')) {
          try {
            await db.delete('colonies', id);
            notify('Koloni dipadam', 'success');
            renderColoniesTable();
            updateDashboard();
            updateDebugInfo();
          } catch (error) {
            notify('Gagal memadam koloni', 'error');
          }
        }
      };
      window.deleteRecord = async (storeName, id) => {
        if (confirm('Padam rekod ini?')) {
          try {
            await db.delete(storeName, id);
            notify('Rekod dipadam', 'success');
            initializePage(storeName); // Re-render the current page
            updateDashboard();
          } catch (error) {
            notify('Gagal memadam rekod', 'error');
          }
        }
      };

      // Initialize when DOM is ready
      document.addEventListener('DOMContentLoaded', async () => {
        console.log('DOM loaded, initializing application...');
        try {
          await db.init();
          console.log('Database initialized successfully');
          await updateDashboard();
          updateDebugInfo();
          
          // Initialize GIS if Google API is available
          if (window.google) {
            await initGIS();
          }
        } catch (error) {
          console.error('Initialization error:', error);
          notify('Error initializing application: ' + error.message, 'error');
        }
      });

    })(window);

    // =============================================
    // SPA Navigation Script
    // =============================================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Setting up SPA navigation...');
      
      // Set up navigation buttons
      document.querySelectorAll('.nav-btn').forEach(button => {
        button.addEventListener('click', function() {
          const pageId = this.getAttribute('data-page');
          console.log('Navigating to page:', pageId);
          showPage(pageId);
        });
      });
      
      // Show dashboard by default
      showPage('dashboard');
    });
    
    function showPage(pageId) {
      console.log('Showing page:', pageId);
      
      // Hide all pages
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      
      // Show selected page
      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.add('active');
        
        // Initialize page-specific functions
        if (typeof initializePage === 'function') {
          initializePage(pageId);
        }
      } else {
        console.error('Page not found:', pageId);
      }
    }

    // =============================================
    // Chart.js Functions
    // =============================================
    function renderChart(){
      const ctx = document.getElementById('chartCanvas').getContext('2d');
      if(window.myChart){ window.myChart.destroy(); }

      const data = {
        labels: ['Jan', 'Feb', 'Mac', 'Apr', 'Mei', 'Jun', 'Jul', 'Ogos', 'Sep', 'Okt', 'Nov', 'Dis'],
        datasets: [{
          label: 'Hasil Tuai (kg)',
          data: [12, 15, 10, 18, 22, 30, 28, 35, 25, 40, 38, 45],
          borderColor: '#FFD700',
          backgroundColor: 'rgba(255,215,0,0.2)',
          tension: 0.4,
          fill: true,
          borderWidth: 2,
          pointRadius: 4
        }]
      };

      const options = {
        plugins: {
          legend: { labels: { color: '#FFD700' } },
          title: { display: false }
        },
        scales: {
          x: { ticks: { color: '#e6e7e9' }, grid: { color: '#222' } },
          y: { ticks: { color: '#e6e7e9' }, grid: { color: '#222' } }
        }
      };

      window.myChart = new Chart(ctx, { type: 'line', data, options });
    }

    // =============================================
    // Settings Page Functions
    // =============================================
    function initializeSettings() {
      console.log('Initializing settings page...');
      
      // Logo upload functionality
      const logoUpload = document.getElementById("kelulutLogoUpload");
      if (logoUpload) {
        logoUpload.addEventListener("change", function(e){
          const f = e.target.files[0]; 
          if(!f) return;
          const fr = new FileReader();
          fr.onload = function(ev){ 
            localStorage.setItem("kelulut_logo_data", ev.target.result); 
            alert("Logo disimpan (untuk invois)."); 
          };
          fr.readAsDataURL(f);
        });
      }
      
      // Remove logo functionality
      const removeLogoBtn = document.getElementById("btnRemoveLogo");
      if (removeLogoBtn) {
        removeLogoBtn.addEventListener("click", function(){ 
          localStorage.removeItem('kelulut_logo_data'); 
          alert('Logo dikeluarkan'); 
        });
      }
    }

    // =============================================
    // Export/Report Functions
    // =============================================
    async function exportStoreXLSX(store) {
      try {
        const rows = await getAll(store);
        if (!rows || rows.length === 0) {
          alert('‚ö†Ô∏è Tiada data untuk dieksport.');
          return;
        }

        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, store);

        const stamp = new Date().toISOString().split('T')[0];
        const filename = `kelulut_${store}_${stamp}.xlsx`;

        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });

        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();

        alert(`‚úÖ Berjaya eksport fail Excel: ${filename}`);
      } catch (e) {
        console.error(e);
        alert('‚ùå Gagal eksport ke Excel: ' + e.message);
      }
    }

    async function exportReportPDF(elemId='reportContainer'){
      const el = document.getElementById(elemId);
      if(!el) return alert('Report element not found');
      const canvas = await html2canvas(el, { scale: 2 });
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','mm','a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const margin = 10;
      const imgProps = pdf.getImageProperties(imgData);
      const imgWidth = pageWidth - margin*2;
      const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
      const now = new Date();
      const fname = 'Laporan_Kelulut_' + now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0') + '.pdf';
      pdf.save(fname);
    }

    // =============================================
    // Debug Functions untuk GitHub Pages
    // =============================================
    function toggleDebug() {
      const panel = document.getElementById('debugPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    async function clearLocalData() {
      if (confirm('Clear all local data?')) {
        localStorage.clear();
        try {
          indexedDB.deleteDatabase('KelulutDB');
          indexedDB.deleteDatabase('kelulut_attachments_db');
        } catch (e) {}
        location.reload();
      }
    }

    async function testAddColony() {
      try {
        const testColony = {
          name: 'TEST_KOLONI_' + Date.now(),
          status: 'active',
          start: new Date().toISOString().split('T')[0]
        };
        const id = await db.add('colonies', testColony);
        document.getElementById('debugInfo').textContent = 'Test colony added: ' + id;
        await renderColoniesTable();
        await updateDashboard();
      } catch (error) {
        document.getElementById('debugInfo').textContent = 'Test failed: ' + error.message;
      }
    }

    async function updateDebugInfo() {
      try {
        const colonies = await db.getAll('colonies');
        const harvests = await db.getAll('harvests');
        document.getElementById('debugInfo').textContent = 
          `Colonies: ${colonies.length} | Harvests: ${harvests.length}`;
      } catch (error) {
        document.getElementById('debugInfo').textContent = 'DB Error: ' + error.message;
      }
    }

    // Auto show debug on error
    window.addEventListener('error', (e) => {
      document.getElementById('debugInfo').textContent = `Error: ${e.message}`;
      document.getElementById('debugPanel').style.display = 'block';
    });

    // Run check after page load
    window.addEventListener('load', () => {
      setTimeout(updateDebugInfo, 1000);
    });

    // =============================================
    // Dark mode toggle
    // =============================================
    (function(){
      try{
        if(localStorage.theme==='light'){
          document.documentElement.style.setProperty('--bg','#f6f7f9');
          document.documentElement.style.setProperty('--card','#ffffff');
          document.documentElement.style.setProperty('--text','#0b0c10');
          document.documentElement.style.setProperty('--muted','#5b6166');
        }
      }catch(e){}
    })();
    
    function toggleTheme(){
      try{
        const t = localStorage.theme==='light'?'dark':'light';
        if(t==='light'){
          document.documentElement.style.setProperty('--bg','#f6f7f9');
          document.documentElement.style.setProperty('--card','#ffffff');
          document.documentElement.style.setProperty('--text','#0b0c10');
          document.documentElement.style.setProperty('--muted','#5b6166');
          localStorage.theme='light';
        } else {
          document.documentElement.style.setProperty('--bg','#0b0c10');
          document.documentElement.style.setProperty('--card','#0f1115');
          document.documentElement.style.setProperty('--text','#e6e7e9');
          document.documentElement.style.setProperty('--muted','#9aa0a6');
          localStorage.theme='dark';
        }
      }catch(e){}
    }

    // Placeholder functions untuk compatibility
    function manualBackup() {
      alert('Backup functionality would be implemented here');
    }

    function manualRestore() {
      alert('Restore functionality would be implemented here');
    }
  </script>
</body>
</html>